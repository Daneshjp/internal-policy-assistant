# Docker Compose Development Overrides
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

version: '3.8'

services:
  postgres:
    # Expose postgres port for local database tools
    ports:
      - "5432:5432"
    # Enable query logging for debugging
    command: ["postgres", "-c", "log_statement=all"]

  redis:
    # Expose redis port for local redis-cli access
    ports:
      - "6379:6379"

  minio:
    # MinIO console for file browsing
    ports:
      - "9000:9000"
      - "9001:9001"

  backend:
    # Development mode with hot reload
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: builder  # Use builder stage for faster rebuilds
    volumes:
      # Mount source code for hot reload
      - ./backend:/app
      # Exclude venv and cache to avoid conflicts
      - /app/.venv
      - /app/__pycache__
      - /app/.pytest_cache
    environment:
      # Development-specific settings
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - RELOAD=true
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
    # Add development ports for debugging
    ports:
      - "8000:8000"
      - "5678:5678"  # Python debugger port

  celery_worker:
    # Development mode
    volumes:
      - ./backend:/app
      - /app/.venv
      - /app/__pycache__
    environment:
      - LOG_LEVEL=DEBUG
    # Enable auto-reload for celery worker
    command: watchfiles --filter python 'celery -A app.tasks worker --loglevel=debug'

  celery_beat:
    # Development mode
    volumes:
      - ./backend:/app
      - /app/.venv
      - /app/__pycache__
    environment:
      - LOG_LEVEL=DEBUG
    command: celery -A app.tasks beat --loglevel=debug

  frontend:
    # Development mode with hot reload
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    volumes:
      # Mount source code for hot reload
      - ./frontend:/app
      # Exclude node_modules to use container's version
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:8000
    ports:
      - "5173:5173"
    command: npm run dev -- --host 0.0.0.0

  # Additional development tools
  adminer:
    # Database management UI
    image: adminer:latest
    container_name: inspectionagent_adminer
    ports:
      - "8080:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
    networks:
      - inspectionagent_network
    depends_on:
      - postgres
    restart: unless-stopped

  mailhog:
    # Email testing tool
    image: mailhog/mailhog:latest
    container_name: inspectionagent_mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    networks:
      - inspectionagent_network
    restart: unless-stopped
